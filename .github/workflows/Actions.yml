name: RDP-Setup with Tailscale Login

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: ubuntu-latest

    steps:
    - name: Install XFCE Desktop + xRDP
      run: |
        echo "Updating packages..."
        sudo apt-get update

        echo "Installing XFCE desktop and xRDP..."
        sudo apt-get install -y xfce4 xfce4-goodies xorg dbus-x11 x11-xserver-utils xrdp

        echo "Configuring xRDP..."
        sudo systemctl enable xrdp
        sudo adduser xrdp ssl-cert
        echo xfce4-session > ~/.xsession
        sudo systemctl restart xrdp

        echo "Creating RDP login user..."
        sudo useradd -m ubuntuuser
        echo "ubuntuuser:12345" | sudo chpasswd
        sudo usermod -aG sudo ubuntuuser

        echo "✅ Desktop & RDP setup complete."

    - name: Install & Connect Tailscale
      env:
        TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        echo "Installing Tailscale..."
        curl -fsSL https://tailscale.com/install.sh | sh

        echo "Starting Tailscale..."
        sudo tailscale up --authkey=${TAILSCALE_AUTHKEY} --hostname=ubuntu-rdp --accept-routes --ssh

        echo "✅ Tailscale connected!"
        echo "Your Tailscale IP is:"
        tailscale ip -4

    - name: Display Connection Info
      run: |
        echo "------------------------------------"
        echo "✅ RDP Server is ready!"
        echo "Use the following credentials to log in via RDP:"
        echo "Username: ubuntuuser"
        echo "Password: 12345"
        echo "------------------------------------"
        echo "Check your Tailscale app to find the device 'ubuntu-rdp'."
        echo "Use its Tailscale IP (100.x.x.x) to connect."
        echo "------------------------------------"

    - name: Keep session alive
      run: |
        echo "Keeping RDP session alive for 6 hours..."
        sleep 21600
