name: RDP-Setup

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: windows-latest

    steps:
    - name: Enable RDP and set password
      shell: powershell
      run: |
        Write-Host "Enabling Remote Desktop Protocol (RDP)..."

        # Enable RDP
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0

        # Allow RDP through Windows Firewall
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        # Create a local user for RDP login
        $username = "rdpuser"
        $password = "P@ssw0rd123"
        net user $username $password /add
        net localgroup "Administrators" $username /add

        Write-Host "RDP user created: $username"
        Write-Host "Password: $password"

        # Show public IP (if reachable)
        try {
          $ip = (Invoke-RestMethod -Uri "https://api.ipify.org?format=text")
          Write-Host "Public IP: $ip"
        } catch {
          Write-Host "Could not fetch public IP. Ensure this is a self-hosted runner."
        }

        Write-Host "RDP has been enabled successfully."

    - name: Keep session alive for 72 hours
      shell: powershell
      run: |
        Write-Host "Keeping RDP session alive for 6 hours..."
        Start-Sleep -Seconds 259200
